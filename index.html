<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Life Command Center</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0f1117;
    --surface: #1a1d27;
    --surface2: #232736;
    --border: #2e3348;
    --text: #e8eaf0;
    --text2: #8b90a5;
    --accent: #6c5ce7;
    --accent2: #a29bfe;
    --green: #00b894;
    --orange: #fdcb6e;
    --red: #e17055;
    --pink: #fd79a8;
    --radius: 16px;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    padding: 20px;
  }

  .header {
    text-align: center;
    padding: 30px 0 12px;
  }

  .header h1 {
    font-family: 'Playfair Display', serif;
    font-size: 2.2rem;
    background: linear-gradient(135deg, var(--accent2), var(--pink));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    margin-bottom: 6px;
  }

  .header p { color: var(--text2); font-size: 0.95rem; }

  .sync-status {
    text-align: center;
    font-size: 0.78rem;
    padding: 6px 0 16px;
    color: var(--text2);
  }

  .sync-status .dot {
    display: inline-block;
    width: 8px; height: 8px;
    border-radius: 50%;
    margin-right: 4px;
    vertical-align: middle;
  }

  .dot-green { background: var(--green); box-shadow: 0 0 6px rgba(0,184,148,0.5); }
  .dot-orange { background: var(--orange); }
  .dot-red { background: var(--red); }

  .date-bar {
    text-align: center;
    color: var(--text2);
    font-size: 0.85rem;
    margin-bottom: 20px;
  }

  /* Setup screen */
  .setup-screen {
    max-width: 500px;
    margin: 60px auto;
    text-align: center;
  }

  .setup-screen h2 {
    font-family: 'Playfair Display', serif;
    font-size: 1.6rem;
    margin-bottom: 12px;
  }

  .setup-screen p {
    color: var(--text2);
    font-size: 0.9rem;
    margin-bottom: 20px;
    line-height: 1.6;
  }

  .setup-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 24px;
    margin-bottom: 16px;
    text-align: left;
  }

  .setup-card h3 { margin-bottom: 12px; font-size: 1rem; }

  .setup-card ol {
    color: var(--text2);
    font-size: 0.88rem;
    padding-left: 20px;
    line-height: 1.8;
  }

  .setup-card ol a {
    color: var(--accent2);
    text-decoration: none;
    font-weight: 700;
  }

  .setup-card ol a:hover { text-decoration: underline; }

  .setup-input-group {
    margin-top: 16px;
  }

  .setup-input-group label {
    display: block;
    font-size: 0.82rem;
    color: var(--text2);
    margin-bottom: 6px;
  }

  .setup-input {
    width: 100%;
    padding: 14px 18px;
    border-radius: 12px;
    border: 1px solid var(--border);
    background: var(--surface2);
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    font-size: 0.9rem;
    outline: none;
  }

  .setup-input:focus { border-color: var(--accent); }

  .setup-btn {
    width: 100%;
    padding: 14px;
    border-radius: 12px;
    border: none;
    background: var(--accent);
    color: #fff;
    font-family: 'DM Sans', sans-serif;
    font-weight: 700;
    font-size: 1rem;
    cursor: pointer;
    margin-top: 16px;
    transition: background 0.3s;
  }

  .setup-btn:hover { background: var(--accent2); }

  .setup-or {
    color: var(--text2);
    font-size: 0.85rem;
    margin: 16px 0;
  }

  .error-msg {
    color: var(--red);
    font-size: 0.85rem;
    margin-top: 8px;
    display: none;
  }

  /* Tabs */
  .tabs {
    display: flex;
    justify-content: center;
    gap: 8px;
    margin-bottom: 24px;
    flex-wrap: wrap;
  }

  .tab {
    padding: 10px 20px;
    border-radius: 50px;
    border: 1px solid var(--border);
    background: transparent;
    color: var(--text2);
    cursor: pointer;
    font-family: 'DM Sans', sans-serif;
    font-size: 0.9rem;
    transition: all 0.3s;
  }

  .tab:hover { border-color: var(--accent); color: var(--text); }
  .tab.active { background: var(--accent); border-color: var(--accent); color: #fff; }

  .section { display: none; max-width: 700px; margin: 0 auto; }
  .section.active { display: block; animation: fadeUp 0.4s ease; }

  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 20px;
    margin-bottom: 16px;
  }

  .card-title {
    font-weight: 700;
    font-size: 1rem;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .input-row {
    display: flex;
    gap: 10px;
    margin-bottom: 16px;
  }

  .input-row input, .input-row select {
    flex: 1;
    padding: 12px 16px;
    border-radius: 12px;
    border: 1px solid var(--border);
    background: var(--surface2);
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    font-size: 0.9rem;
    outline: none;
  }

  .input-row input:focus, .input-row select:focus { border-color: var(--accent); }
  .input-row select { flex: 0.5; min-width: 100px; }

  .add-btn {
    padding: 12px 20px;
    border-radius: 12px;
    border: none;
    background: var(--accent);
    color: #fff;
    font-family: 'DM Sans', sans-serif;
    font-weight: 700;
    cursor: pointer;
    white-space: nowrap;
    transition: background 0.3s, transform 0.1s;
  }

  .add-btn:hover { background: var(--accent2); }
  .add-btn:active { transform: scale(0.96); }

  .task-list { list-style: none; }

  .task-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 14px 16px;
    background: var(--surface2);
    border-radius: 12px;
    margin-bottom: 8px;
    animation: fadeUp 0.3s ease;
  }

  .task-item.done { opacity: 0.45; }
  .task-item.done .task-text { text-decoration: line-through; }

  .checkbox {
    width: 22px; height: 22px;
    border-radius: 50%;
    border: 2px solid var(--border);
    cursor: pointer;
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s;
  }

  .checkbox:hover { border-color: var(--accent); }
  .checkbox.checked { background: var(--green); border-color: var(--green); }
  .checkbox.checked::after { content: '‚úì'; color: #fff; font-size: 12px; font-weight: 700; }

  .task-text { flex: 1; font-size: 0.92rem; }

  .task-tag {
    padding: 4px 10px;
    border-radius: 50px;
    font-size: 0.72rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .tag-work { background: rgba(108,92,231,0.2); color: var(--accent2); }
  .tag-personal { background: rgba(253,121,168,0.2); color: var(--pink); }
  .tag-health { background: rgba(0,184,148,0.2); color: var(--green); }
  .tag-urgent { background: rgba(225,112,85,0.2); color: var(--red); }

  .delete-btn {
    background: none;
    border: none;
    color: var(--text2);
    cursor: pointer;
    font-size: 1.1rem;
    padding: 4px;
    border-radius: 8px;
    opacity: 0;
  }

  .task-item:hover .delete-btn { opacity: 1; }
  .delete-btn:hover { color: var(--red); }

  .priority-dot {
    width: 8px; height: 8px;
    border-radius: 50%;
    flex-shrink: 0;
  }

  .priority-high { background: var(--red); box-shadow: 0 0 8px rgba(225,112,85,0.5); }
  .priority-medium { background: var(--orange); }
  .priority-low { background: var(--green); }

  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 12px;
    margin-bottom: 20px;
  }

  .stat-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 20px;
    text-align: center;
  }

  .stat-number { font-size: 2rem; font-weight: 700; font-family: 'Playfair Display', serif; }
  .stat-label { font-size: 0.78rem; color: var(--text2); margin-top: 4px; text-transform: uppercase; letter-spacing: 1px; }

  .progress-wrap {
    background: var(--surface2);
    border-radius: 50px;
    height: 10px;
    overflow: hidden;
    margin-top: 10px;
  }

  .progress-fill {
    height: 100%;
    border-radius: 50px;
    background: linear-gradient(90deg, var(--accent), var(--pink));
    transition: width 0.5s ease;
  }

  .review-prompt {
    background: linear-gradient(135deg, rgba(108,92,231,0.15), rgba(253,121,168,0.1));
    border: 1px solid rgba(108,92,231,0.3);
    border-radius: var(--radius);
    padding: 24px;
    margin-bottom: 16px;
  }

  .review-prompt h3 { font-family: 'Playfair Display', serif; margin-bottom: 8px; }
  .review-prompt p { color: var(--text2); font-size: 0.9rem; line-height: 1.6; }

  textarea {
    width: 100%;
    padding: 14px 16px;
    border-radius: 12px;
    border: 1px solid var(--border);
    background: var(--surface2);
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    font-size: 0.9rem;
    outline: none;
    resize: vertical;
    min-height: 80px;
  }

  textarea:focus { border-color: var(--accent); }

  .empty-state { text-align: center; padding: 40px 20px; color: var(--text2); }
  .empty-state .emoji { font-size: 2.5rem; margin-bottom: 12px; }

  .section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
  }

  .section-header h2 { font-family: 'Playfair Display', serif; font-size: 1.3rem; }

  .clear-done {
    background: none;
    border: 1px solid var(--border);
    color: var(--text2);
    padding: 8px 16px;
    border-radius: 50px;
    font-family: 'DM Sans', sans-serif;
    font-size: 0.8rem;
    cursor: pointer;
  }

  .clear-done:hover { border-color: var(--red); color: var(--red); }

  .guide-step {
    display: flex;
    gap: 14px;
    margin-bottom: 16px;
    align-items: flex-start;
  }

  .step-num {
    width: 32px; height: 32px;
    border-radius: 50%;
    background: var(--accent);
    color: #fff;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 0.85rem;
    flex-shrink: 0;
  }

  .step-content h4 { margin-bottom: 4px; font-size: 0.95rem; }
  .step-content p { color: var(--text2); font-size: 0.85rem; line-height: 1.5; }

  .settings-btn {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 44px; height: 44px;
    border-radius: 50%;
    background: var(--surface);
    border: 1px solid var(--border);
    color: var(--text2);
    font-size: 1.2rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 100;
  }

  .settings-btn:hover { border-color: var(--accent); color: var(--accent2); }

  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(12px); }
    to { opacity: 1; transform: translateY(0); }
  }

  @media (max-width: 600px) {
    .header h1 { font-size: 1.7rem; }
    .input-row { flex-wrap: wrap; }
    .input-row select { flex: 1; }
    .stats-grid { grid-template-columns: repeat(2, 1fr); }
    body { padding: 12px; }
  }
</style>
</head>
<body>

<!-- SETUP SCREEN -->
<div id="setupScreen" class="setup-screen" style="display:none;">
  <h2>üîó Sync sozlash</h2>
  <p>Telefon va kompyuterda bir xil ma'lumot ko'rish uchun bepul JSONBin.io xizmatidan foydalanamiz. Bitta marta sozlab qo'ying ‚Äî keyin avtomatik ishlaydi.</p>

  <div class="setup-card">
    <h3>üìã Bosqichma-bosqich:</h3>
    <ol>
      <li><a href="https://jsonbin.io" target="_blank">jsonbin.io</a> ga o'ting</li>
      <li><strong>Sign Up</strong> bosing (bepul)</li>
      <li>Ro'yxatdan o'tgandan keyin <strong>API Keys</strong> bo'limiga o'ting</li>
      <li><strong>X-Master-Key</strong> ni nusxalang (ko'rsatilgan uzun matn)</li>
      <li>Shu pastga joylashtiring:</li>
    </ol>

    <div class="setup-input-group">
      <label>X-Master-Key (JSONBin.io dan)</label>
      <input type="text" class="setup-input" id="apiKeyInput" placeholder="$2a$10$xxxxxxxxxxxxxxxxxxxxxxxx">
    </div>

    <div class="error-msg" id="setupError">‚ùå Kalit noto'g'ri yoki ulanish muammo. Qayta tekshiring.</div>

    <button class="setup-btn" onclick="setupSync()">üöÄ Ulash va boshlash</button>
  </div>

  <div class="setup-or">‚Äî yoki ‚Äî</div>

  <button class="setup-btn" style="background: var(--surface2); border: 1px solid var(--border);" onclick="skipSetup()">
    Sync'siz davom etish (faqat shu qurilma)
  </button>
</div>

<!-- MAIN APP -->
<div id="mainApp" style="display:none;">
  <div class="header">
    <h1>Life Command Center</h1>
    <p>Simple. Powerful. Synced.</p>
  </div>

  <div class="sync-status" id="syncStatus">
    <span class="dot dot-green" id="syncDot"></span>
    <span id="syncText">Checking sync...</span>
    <button onclick="manualSync()" id="syncBtn" style="margin-left:8px;background:none;border:1px solid var(--border);color:var(--accent2);padding:4px 12px;border-radius:50px;font-size:0.75rem;cursor:pointer;font-family:inherit;display:none">üîÑ Refresh</button>
  </div>

  <div class="date-bar" id="dateBar"></div>

  <div class="tabs">
    <button class="tab active" onclick="switchTab('today', this)">üìã Today</button>
    <button class="tab" onclick="switchTab('projects', this)">üöÄ Projects</button>
    <button class="tab" onclick="switchTab('habits', this)">‚ú® Habits</button>
    <button class="tab" onclick="switchTab('review', this)">üîÑ Review</button>
    <button class="tab" onclick="switchTab('guide', this)">‚ùì Guide</button>
  </div>

  <!-- TODAY -->
  <div class="section active" id="today">
    <div class="stats-grid" id="todayStats"></div>
    <div class="card">
      <div class="card-title">‚ûï Add Task</div>
      <div class="input-row">
        <input type="text" id="taskInput" placeholder="What needs to be done?" onkeypress="if(event.key==='Enter')addTask()">
        <select id="taskCategory">
          <option value="work">Work</option>
          <option value="personal">Personal</option>
          <option value="health">Health</option>
          <option value="urgent">Urgent</option>
        </select>
        <select id="taskPriority">
          <option value="high">High</option>
          <option value="medium">Medium</option>
          <option value="low">Low</option>
        </select>
        <button class="add-btn" onclick="addTask()">Add</button>
      </div>
    </div>
    <div class="section-header">
      <h2>Today's Tasks</h2>
      <button class="clear-done" onclick="clearDone('tasks')">Clear done</button>
    </div>
    <ul class="task-list" id="taskList"></ul>
    <div class="empty-state" id="taskEmpty"><div class="emoji">üéØ</div><p>No tasks yet. Add your first task above!</p></div>
    <div class="card" style="margin-top:20px">
      <div class="card-title">üìä Today's Progress</div>
      <div class="progress-wrap"><div class="progress-fill" id="todayProgress" style="width:0%"></div></div>
      <p style="color:var(--text2);font-size:0.82rem;margin-top:8px" id="progressText">Complete tasks to fill the bar!</p>
    </div>
  </div>

  <!-- PROJECTS -->
  <div class="section" id="projects">
    <div class="card">
      <div class="card-title">‚ûï Add Project</div>
      <div class="input-row">
        <input type="text" id="projectInput" placeholder="Project name..." onkeypress="if(event.key==='Enter')addProject()">
        <input type="date" id="projectDeadline">
        <button class="add-btn" onclick="addProject()">Add</button>
      </div>
    </div>
    <div class="section-header">
      <h2>Active Projects</h2>
      <button class="clear-done" onclick="clearDone('projects')">Clear done</button>
    </div>
    <ul class="task-list" id="projectList"></ul>
    <div class="empty-state" id="projectEmpty"><div class="emoji">üöÄ</div><p>No projects yet.</p></div>
  </div>

  <!-- HABITS -->
  <div class="section" id="habits">
    <div class="card">
      <div class="card-title">‚ûï Add Habit</div>
      <div class="input-row">
        <input type="text" id="habitInput" placeholder="e.g., Exercise, Read, Meditate..." onkeypress="if(event.key==='Enter')addHabit()">
        <button class="add-btn" onclick="addHabit()">Add</button>
      </div>
    </div>
    <div class="section-header">
      <h2>Daily Habits</h2>
      <button class="clear-done" onclick="resetHabits()">Reset all</button>
    </div>
    <ul class="task-list" id="habitList"></ul>
    <div class="empty-state" id="habitEmpty"><div class="emoji">‚ú®</div><p>Add your first habit above.</p></div>
    <div class="card" style="margin-top:20px">
      <div class="card-title">üî• Habit Progress</div>
      <div class="progress-wrap"><div class="progress-fill" id="habitProgress" style="width:0%"></div></div>
      <p style="color:var(--text2);font-size:0.82rem;margin-top:8px" id="habitProgressText">Complete your habits daily!</p>
    </div>
  </div>

  <!-- REVIEW -->
  <div class="section" id="review">
    <div class="review-prompt">
      <h3>üîÑ Weekly Review</h3>
      <p>Take 15 minutes every week to reflect. This is the secret to staying on track.</p>
    </div>
    <div class="card"><div class="card-title">üèÜ What went well?</div><textarea id="reviewWins" placeholder="List your wins..."></textarea></div>
    <div class="card"><div class="card-title">ü§î What could be better?</div><textarea id="reviewImprove" placeholder="What to change?"></textarea></div>
    <div class="card"><div class="card-title">üéØ Top 3 next week</div><textarea id="reviewNext" placeholder="1.&#10;2.&#10;3."></textarea></div>
    <button class="add-btn" style="width:100%;padding:14px;margin-top:8px" onclick="saveReviewData()">Save Review</button>
  </div>

  <!-- GUIDE -->
  <div class="section" id="guide">
    <div class="card">
      <div class="card-title" style="font-family:'Playfair Display',serif;font-size:1.2rem">How to Use</div>
      <div class="guide-step"><div class="step-num">1</div><div class="step-content"><h4>Every Morning (2 min)</h4><p>Add all tasks for today. Set priority: High = do first.</p></div></div>
      <div class="guide-step"><div class="step-num">2</div><div class="step-content"><h4>During the Day</h4><p>Work on HIGH priority first. Check off as you go.</p></div></div>
      <div class="guide-step"><div class="step-num">3</div><div class="step-content"><h4>Track Big Projects</h4><p>"Projects" tab for multi-day work. Set deadlines.</p></div></div>
      <div class="guide-step"><div class="step-num">4</div><div class="step-content"><h4>Build Habits</h4><p>Add 3-5 daily habits. Check them off every day.</p></div></div>
      <div class="guide-step"><div class="step-num">5</div><div class="step-content"><h4>Weekly Review (Sunday)</h4><p>"Review" tab ‚Äî wins, improvements, next week priorities.</p></div></div>
      <div class="guide-step"><div class="step-num">‚≠ê</div><div class="step-content"><h4>Golden Rule</h4><p>If a task takes less than 2 minutes ‚Äî do it NOW.</p></div></div>
    </div>
  </div>

  <button class="settings-btn" onclick="showSetup()" title="Sync settings">‚öôÔ∏è</button>
</div>

<script>
  // ============ CONFIG ============
  let CONFIG = {
    apiKey: '',
    binId: '',
    syncEnabled: false
  };

  let data = { tasks: [], projects: [], habits: [], review: { wins: '', improve: '', next: '' } };
  let syncTimer = null;

  // ============ JSONBIN API ============
  const JSONBIN_BASE = 'https://api.jsonbin.io/v3';

  async function apiFetch(url, options = {}) {
    // Use no-cors workaround: JSONBin supports CORS, but file:// origin is blocked
    // Solution: must be served from http/https (GitHub Pages, etc.)
    const controller = new AbortController();
    const timeout = setTimeout(() => controller.abort(), 10000);
    try {
      const res = await fetch(url, { ...options, signal: controller.signal });
      clearTimeout(timeout);
      return res;
    } catch (e) {
      clearTimeout(timeout);
      if (window.location.protocol === 'file:') {
        throw new Error('FILE_PROTOCOL');
      }
      throw e;
    }
  }

  async function createBin(apiKey) {
    const res = await apiFetch(`${JSONBIN_BASE}/b`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-Master-Key': apiKey,
        'X-Bin-Name': 'life-command-center',
        'X-Bin-Private': 'true'
      },
      body: JSON.stringify(data)
    });
    if (!res.ok) throw new Error('Failed to create bin: ' + res.status);
    const json = await res.json();
    return json.metadata.id;
  }

  async function loadFromCloud() {
    if (!CONFIG.syncEnabled) return;
    try {
      const res = await apiFetch(`${JSONBIN_BASE}/b/${CONFIG.binId}/latest`, {
        headers: { 'X-Master-Key': CONFIG.apiKey }
      });
      if (!res.ok) throw new Error('Load failed');
      const json = await res.json();
      data = json.record || data;
      renderAll();
      setSyncStatus('green', 'Synced ‚úì');
    } catch (e) {
      console.error('Load error:', e);
      if (e.message === 'FILE_PROTOCOL') {
        setSyncStatus('orange', 'Local mode ‚Äî upload to GitHub Pages for sync');
      } else {
        setSyncStatus('red', 'Sync error ‚Äî using local data');
      }
    }
  }

  async function saveToCloud() {
    if (!CONFIG.syncEnabled) return;
    try {
      setSyncStatus('orange', 'Saving...');
      const res = await apiFetch(`${JSONBIN_BASE}/b/${CONFIG.binId}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'X-Master-Key': CONFIG.apiKey
        },
        body: JSON.stringify(data)
      });
      if (!res.ok) throw new Error('Save failed');
      setSyncStatus('green', 'Synced ‚úì');
    } catch (e) {
      console.error('Save error:', e);
      if (e.message === 'FILE_PROTOCOL') {
        setSyncStatus('orange', 'Local mode ‚Äî upload to GitHub Pages for sync');
      } else {
        setSyncStatus('red', 'Sync error');
      }
    }
  }

  // Debounced save
  function scheduleSave() {
    localStorage.setItem('lcc_data', JSON.stringify(data));
    if (!CONFIG.syncEnabled) return;
    clearTimeout(syncTimer);
    syncTimer = setTimeout(saveToCloud, 5000); // 5 sec debounce to batch changes
  }

  function setSyncStatus(color, text) {
    const dot = document.getElementById('syncDot');
    const txt = document.getElementById('syncText');
    const btn = document.getElementById('syncBtn');
    dot.className = 'dot dot-' + color;
    txt.textContent = text;
    if (btn) btn.style.display = CONFIG.syncEnabled ? 'inline-block' : 'none';
  }

  async function manualSync() {
    if (!CONFIG.syncEnabled) return;
    setSyncStatus('orange', 'Syncing...');
    await loadFromCloud();
  }

  // ============ SETUP ============
  async function setupSync() {
    const apiKey = document.getElementById('apiKeyInput').value.trim();
    const errorEl = document.getElementById('setupError');
    errorEl.style.display = 'none';

    if (!apiKey) { errorEl.textContent = '‚ùå API kalitni kiriting.'; errorEl.style.display = 'block'; return; }

    try {
      // Check if running from file://
      if (window.location.protocol === 'file:') {
        // Save key locally, sync will work after uploading to GitHub Pages
        CONFIG = { apiKey, binId: '', syncEnabled: false };
        localStorage.setItem('lcc_apiKey', apiKey);
        localStorage.setItem('lcc_syncEnabled', 'pending');

        errorEl.style.display = 'block';
        errorEl.style.color = 'var(--orange)';
        errorEl.textContent = '‚ö†Ô∏è API kalit saqlandi! Lekin sync ishlashi uchun faylni GitHub Pages\'ga yuklang. Hozircha local rejimda ishlaydi.';

        setTimeout(() => {
          document.getElementById('setupScreen').style.display = 'none';
          document.getElementById('mainApp').style.display = 'block';
          setSyncStatus('orange', 'Upload to GitHub Pages for sync');
          renderAll();
          updateDate();
        }, 3000);
        return;
      }

      // Check if we already have a bin
      const savedBin = localStorage.getItem('lcc_binId');
      let binId;

      if (savedBin) {
        // Verify existing bin works
        const res = await fetch(`${JSONBIN_BASE}/b/${savedBin}/latest`, {
          headers: { 'X-Master-Key': apiKey }
        });
        if (res.ok) {
          binId = savedBin;
        } else {
          binId = await createBin(apiKey);
        }
      } else {
        binId = await createBin(apiKey);
      }

      CONFIG = { apiKey, binId, syncEnabled: true };
      localStorage.setItem('lcc_apiKey', apiKey);
      localStorage.setItem('lcc_binId', binId);
      localStorage.setItem('lcc_syncEnabled', 'true');

      document.getElementById('setupScreen').style.display = 'none';
      document.getElementById('mainApp').style.display = 'block';

      await loadFromCloud();
      renderAll();
      updateDate();

    } catch (e) {
      console.error('Setup error:', e);
      errorEl.textContent = '‚ùå Xatolik! API kalitni tekshiring va qayta urinib ko\'ring.';
      errorEl.style.display = 'block';
    }
  }

  function skipSetup() {
    CONFIG.syncEnabled = false;
    localStorage.setItem('lcc_syncEnabled', 'false');
    document.getElementById('setupScreen').style.display = 'none';
    document.getElementById('mainApp').style.display = 'block';

    const savedData = localStorage.getItem('lcc_data');
    if (savedData) { try { data = JSON.parse(savedData); } catch(e) {} }

    setSyncStatus('orange', 'Local only ‚Äî no sync');
    renderAll();
    updateDate();
  }

  function showSetup() {
    document.getElementById('mainApp').style.display = 'none';
    document.getElementById('setupScreen').style.display = 'block';
    document.getElementById('apiKeyInput').value = CONFIG.apiKey || '';
  }

  // ============ INIT ============
  function init() {
    const savedKey = localStorage.getItem('lcc_apiKey');
    const savedBin = localStorage.getItem('lcc_binId');
    const savedSync = localStorage.getItem('lcc_syncEnabled');
    const savedData = localStorage.getItem('lcc_data');

    if (savedData) { try { data = JSON.parse(savedData); } catch(e) {} }

    if (savedSync === 'true' && savedKey && savedBin) {
      CONFIG = { apiKey: savedKey, binId: savedBin, syncEnabled: true };
      document.getElementById('setupScreen').style.display = 'none';
      document.getElementById('mainApp').style.display = 'block';
      loadFromCloud();
      renderAll();
      updateDate();
      // No auto-refresh ‚Äî manual only to save API requests
    } else if (savedSync === 'pending' && savedKey && window.location.protocol !== 'file:') {
      // Was setup locally, now running on GitHub Pages ‚Äî complete setup
      CONFIG = { apiKey: savedKey, binId: '', syncEnabled: false };
      document.getElementById('setupScreen').style.display = 'none';
      document.getElementById('mainApp').style.display = 'block';
      renderAll();
      updateDate();
      setSyncStatus('orange', 'Completing sync setup...');
      // Create bin now
      createBin(savedKey).then(binId => {
        CONFIG = { apiKey: savedKey, binId, syncEnabled: true };
        localStorage.setItem('lcc_binId', binId);
        localStorage.setItem('lcc_syncEnabled', 'true');
        saveToCloud();
      }).catch(e => {
        console.error(e);
        setSyncStatus('red', 'Setup failed ‚Äî tap ‚öôÔ∏è to retry');
      });
    } else if (savedSync === 'false' || savedSync === 'pending') {
      skipSetup();
    } else {
      document.getElementById('setupScreen').style.display = 'block';
    }
  }

  // ============ APP LOGIC ============
  function escHtml(t) { const d = document.createElement('div'); d.textContent = t; return d.innerHTML; }

  function updateDate() {
    const now = new Date();
    document.getElementById('dateBar').textContent = now.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
  }

  function switchTab(tab, el) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.getElementById(tab).classList.add('active');
    el.classList.add('active');
  }

  function renderAll() {
    renderTasks();
    renderProjects();
    renderHabits();
    loadReview();
  }

  // TASKS
  function addTask() {
    const input = document.getElementById('taskInput');
    const text = input.value.trim();
    if (!text) return;
    data.tasks.push({ id: Date.now(), text, category: document.getElementById('taskCategory').value, priority: document.getElementById('taskPriority').value, done: false });
    input.value = '';
    scheduleSave();
    renderTasks();
  }

  function toggleTask(id) {
    const t = data.tasks.find(x => x.id === id);
    if (t) t.done = !t.done;
    scheduleSave();
    renderTasks();
  }

  function deleteTask(id) {
    data.tasks = data.tasks.filter(x => x.id !== id);
    scheduleSave();
    renderTasks();
  }

  function renderTasks() {
    const list = document.getElementById('taskList');
    const empty = document.getElementById('taskEmpty');
    const priOrder = { high: 0, medium: 1, low: 2 };
    const sorted = [...data.tasks].sort((a, b) => {
      if (a.done !== b.done) return a.done ? 1 : -1;
      return priOrder[a.priority] - priOrder[b.priority];
    });

    if (sorted.length === 0) { list.innerHTML = ''; empty.style.display = 'block'; }
    else {
      empty.style.display = 'none';
      list.innerHTML = sorted.map(t => `
        <li class="task-item ${t.done?'done':''}">
          <div class="priority-dot priority-${t.priority}"></div>
          <div class="checkbox ${t.done?'checked':''}" onclick="toggleTask(${t.id})"></div>
          <span class="task-text">${escHtml(t.text)}</span>
          <span class="task-tag tag-${t.category}">${t.category}</span>
          <button class="delete-btn" onclick="deleteTask(${t.id})">‚úï</button>
        </li>`).join('');
    }
    updateStats();
  }

  function updateStats() {
    const total = data.tasks.length, done = data.tasks.filter(t => t.done).length;
    const urgent = data.tasks.filter(t => !t.done && t.priority === 'high').length;
    const pct = total > 0 ? Math.round((done / total) * 100) : 0;
    document.getElementById('todayStats').innerHTML = `
      <div class="stat-card"><div class="stat-number" style="color:var(--accent2)">${total}</div><div class="stat-label">Total</div></div>
      <div class="stat-card"><div class="stat-number" style="color:var(--green)">${done}</div><div class="stat-label">Done</div></div>
      <div class="stat-card"><div class="stat-number" style="color:var(--red)">${urgent}</div><div class="stat-label">High</div></div>
      <div class="stat-card"><div class="stat-number" style="color:var(--pink)">${pct}%</div><div class="stat-label">Progress</div></div>`;
    document.getElementById('todayProgress').style.width = pct + '%';
    document.getElementById('progressText').textContent = total > 0 ? `${done}/${total} completed (${pct}%)` : 'Add tasks to track progress!';
  }

  // PROJECTS
  function addProject() {
    const input = document.getElementById('projectInput');
    const text = input.value.trim();
    if (!text) return;
    data.projects.push({ id: Date.now(), text, deadline: document.getElementById('projectDeadline').value, done: false });
    input.value = '';
    document.getElementById('projectDeadline').value = '';
    scheduleSave();
    renderProjects();
  }

  function toggleProject(id) { const p = data.projects.find(x => x.id === id); if (p) p.done = !p.done; scheduleSave(); renderProjects(); }
  function deleteProject(id) { data.projects = data.projects.filter(x => x.id !== id); scheduleSave(); renderProjects(); }

  function renderProjects() {
    const list = document.getElementById('projectList');
    const empty = document.getElementById('projectEmpty');
    const sorted = [...data.projects].sort((a, b) => a.done ? 1 : -1);
    if (sorted.length === 0) { list.innerHTML = ''; empty.style.display = 'block'; }
    else {
      empty.style.display = 'none';
      list.innerHTML = sorted.map(p => {
        const dl = p.deadline ? `<span style="color:var(--text2);font-size:0.78rem">üìÖ ${new Date(p.deadline+'T00:00').toLocaleDateString('en-US',{month:'short',day:'numeric'})}</span>` : '';
        const overdue = p.deadline && !p.done && new Date(p.deadline) < new Date();
        return `<li class="task-item ${p.done?'done':''}" ${overdue?'style="border-left:3px solid var(--red)"':''}>
          <div class="checkbox ${p.done?'checked':''}" onclick="toggleProject(${p.id})"></div>
          <span class="task-text">${escHtml(p.text)}</span>${dl}
          <button class="delete-btn" onclick="deleteProject(${p.id})">‚úï</button></li>`;
      }).join('');
    }
  }

  // HABITS
  function addHabit() {
    const input = document.getElementById('habitInput');
    const text = input.value.trim();
    if (!text) return;
    data.habits.push({ id: Date.now(), text, done: false, streak: 0 });
    input.value = '';
    scheduleSave();
    renderHabits();
  }

  function toggleHabit(id) {
    const h = data.habits.find(x => x.id === id);
    if (h) { h.done = !h.done; h.streak = h.done ? (h.streak||0)+1 : Math.max(0,(h.streak||0)-1); }
    scheduleSave();
    renderHabits();
  }

  function deleteHabit(id) { data.habits = data.habits.filter(x => x.id !== id); scheduleSave(); renderHabits(); }
  function resetHabits() { data.habits.forEach(h => h.done = false); scheduleSave(); renderHabits(); }

  function renderHabits() {
    const list = document.getElementById('habitList');
    const empty = document.getElementById('habitEmpty');
    if (data.habits.length === 0) { list.innerHTML = ''; empty.style.display = 'block'; }
    else {
      empty.style.display = 'none';
      list.innerHTML = data.habits.map(h => `
        <li class="task-item ${h.done?'done':''}">
          <div class="checkbox ${h.done?'checked':''}" onclick="toggleHabit(${h.id})"></div>
          <span class="task-text">${escHtml(h.text)}</span>
          <span style="color:var(--orange);font-size:0.8rem;font-weight:700">üî• ${h.streak||0}</span>
          <button class="delete-btn" onclick="deleteHabit(${h.id})">‚úï</button></li>`).join('');
    }
    const total = data.habits.length, done = data.habits.filter(h => h.done).length;
    const pct = total > 0 ? Math.round((done/total)*100) : 0;
    document.getElementById('habitProgress').style.width = pct + '%';
    document.getElementById('habitProgressText').textContent = total > 0 ? `${done}/${total} done (${pct}%)` : 'Add habits!';
  }

  // REVIEW
  function loadReview() {
    document.getElementById('reviewWins').value = data.review.wins || '';
    document.getElementById('reviewImprove').value = data.review.improve || '';
    document.getElementById('reviewNext').value = data.review.next || '';
  }

  function saveReviewData() {
    data.review = {
      wins: document.getElementById('reviewWins').value,
      improve: document.getElementById('reviewImprove').value,
      next: document.getElementById('reviewNext').value,
      date: new Date().toISOString()
    };
    scheduleSave();
    alert('Review saved! ‚úÖ');
  }

  // CLEAR DONE
  function clearDone(type) {
    if (type === 'tasks') data.tasks = data.tasks.filter(t => !t.done);
    else if (type === 'projects') data.projects = data.projects.filter(p => !p.done);
    scheduleSave();
    renderAll();
  }

  // START
  init();
</script>
</body>
</html>
